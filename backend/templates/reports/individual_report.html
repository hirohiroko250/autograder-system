<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人成績表 - 全国学力向上テスト</title>
    <style>
{{ css_content|safe }}
    </style>
</head>
<body>
    <div class="report-page">
        <!-- ヘッダー -->
        <header class="header">
            <div class="logo">
                <img src="/static/reports/logo.png" alt="全国学力向上テスト">
            </div>
            <div class="header-right">
                <p class="issue-date">発行日：{{ issue_date }}</p>
                <div class="test-info">
                    <span class="info-label">学年</span>
                    <span class="info-value">{{ student_grade }}</span>
                    <span class="info-label">第</span>
                    <span class="info-value">{{ test_iteration }}</span>
                    <span class="info-label">回</span>
                    <span class="info-label">年度</span>
                    <span class="info-value">{{ test_year }}</span>
                </div>
                <h1 class="main-title">個人成績表</h1>
            </div>
        </header>

        <!-- 窓あき封筒用エリアと生徒情報 -->
        <div class="top-area">
            <!-- 窓あき封筒用 -->
            <div class="window-area">
                <div class="window-frame">
                    <div class="window-content">
                        <!-- 空白エリア -->
                    </div>
                </div>
            </div>

            <!-- 生徒情報 -->
            <div class="student-info">
                <div class="info-row">
                    <div class="info-item">
                        <span class="label">生徒氏名</span>
                        <span class="value">{{ student_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">学年</span>
                        <span class="value">{{ student_grade }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">受験ID</span>
                        <span class="value">{{ student_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">生徒ID</span>
                        <span class="value">{{ student_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">塾名</span>
                        <span class="value">{{ school_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">塾ID</span>
                        <span class="value">{{ school_id }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-layout">
            <!-- 左側カラム -->
            <div class="left-column">
                <!-- 得点・偏差値・順位 -->
                <section class="score-section">
                    <h2 class="section-title"><span class="diamond">◆</span>得点・偏差値・順位</h2>

                    <table class="score-table">
                        <thead>
                            <tr>
                                <th class="label-col">教科</th>
                                <th class="total-col">合計</th>
                                <th class="japanese-col">国語</th>
                                <th class="math-col">算数</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">得点</td>
                                <td class="total-cell">{{ total_score }}<span class="unit">点</span></td>
                                <td class="japanese-cell">{{ japanese_score }}<span class="unit">点</span></td>
                                <td class="math-cell">{{ math_score }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">偏差値</td>
                                <td class="total-cell">{{ total_deviation }}</td>
                                <td class="japanese-cell">{{ japanese_deviation }}</td>
                                <td class="math-cell">{{ math_deviation }}</td>
                            </tr>
                            <tr>
                                <td class="label-cell">学年順位<br><span class="sub-label">(学年受験者数)</span></td>
                                <td class="total-cell">{{ total_grade_rank }}<span class="unit">位</span><br><span class="sub-value">({{ total_grade_total }}人中)</span></td>
                                <td class="japanese-cell">{{ japanese_grade_rank }}<span class="unit">位</span><br><span class="sub-value">({{ japanese_grade_total }}人中)</span></td>
                                <td class="math-cell">{{ math_grade_rank }}<span class="unit">位</span><br><span class="sub-value">({{ math_grade_total }}人中)</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">塾内順位<br><span class="sub-label">(受験者数)</span></td>
                                <td class="total-cell">{{ total_school_rank }}<span class="unit">位</span><br><span class="sub-value">({{ total_school_total }}人中)</span></td>
                                <td class="japanese-cell">{{ japanese_school_rank }}<span class="unit">位</span><br><span class="sub-value">({{ japanese_school_total }}人中)</span></td>
                                <td class="math-cell">{{ math_school_rank }}<span class="unit">位</span><br><span class="sub-value">({{ math_school_total }}人中)</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">最高点<br><span class="sub-label">(全国)</span></td>
                                <td>{{ total_national_highest }}<span class="unit">点</span></td>
                                <td>{{ japanese_national_highest }}<span class="unit">点</span></td>
                                <td>{{ math_national_highest }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">最高点<br><span class="sub-label">(塾内)</span></td>
                                <td>{{ total_school_highest }}<span class="unit">点</span></td>
                                <td>{{ japanese_school_highest }}<span class="unit">点</span></td>
                                <td>{{ math_school_highest }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">平均点<br><span class="sub-label">(学年平均)</span></td>
                                <td>{{ total_grade_avg }}<span class="unit">点</span></td>
                                <td>{{ japanese_grade_avg }}<span class="unit">点</span></td>
                                <td>{{ math_grade_avg }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">平均点<br><span class="sub-label">(塾内)</span></td>
                                <td>{{ total_school_avg }}<span class="unit">点</span></td>
                                <td>{{ japanese_school_avg }}<span class="unit">点</span></td>
                                <td>{{ math_school_avg }}<span class="unit">点</span></td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- 成績の推移 -->
                <section class="trend-section">
                    <h2 class="section-title"><span class="diamond">◆</span>成績の推移</h2>
                    <p class="trend-legend">
                        <span class="legend-item"><span class="legend-bar"></span>あなたの得点</span>
                        <span class="legend-item"><span class="legend-star">★</span>学年平均</span>
                    </p>

                    <div class="trend-graphs">
                        <!-- 全教科 -->
                        <div class="trend-graph total-graph">
                            <div class="graph-header total-bg">全教科</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 140" class="line-chart" id="totalChart_{{ student_id }}">
                                    <!-- グリッド線と軸ラベル -->
                                    <line x1="40" y1="20" x2="40" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <line x1="40" y1="110" x2="190" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <!-- Y軸ラベル -->
                                    <text x="20" y="20" font-size="9" fill="#666">100</text>
                                    <text x="20" y="65" font-size="9" fill="#666">50</text>
                                    <text x="28" y="115" font-size="9" fill="#666">0</text>
                                    <!-- グリッド線 -->
                                    <line x1="40" y1="20" x2="190" y2="20" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                    <line x1="40" y1="65" x2="190" y2="65" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                </svg>
                            </div>
                        </div>

                        <!-- 算数 -->
                        <div class="trend-graph math-graph">
                            <div class="graph-header math-bg">算数</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 140" class="line-chart" id="mathChart_{{ student_id }}">
                                    <line x1="40" y1="20" x2="40" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <line x1="40" y1="110" x2="190" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <text x="20" y="20" font-size="9" fill="#666">100</text>
                                    <text x="20" y="65" font-size="9" fill="#666">50</text>
                                    <text x="28" y="115" font-size="9" fill="#666">0</text>
                                    <line x1="40" y1="20" x2="190" y2="20" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                    <line x1="40" y1="65" x2="190" y2="65" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                </svg>
                            </div>
                        </div>

                        <!-- 国語 -->
                        <div class="trend-graph japanese-graph">
                            <div class="graph-header japanese-bg">国語</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 140" class="line-chart" id="japaneseChart_{{ student_id }}">
                                    <line x1="40" y1="20" x2="40" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <line x1="40" y1="110" x2="190" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <text x="20" y="20" font-size="9" fill="#666">100</text>
                                    <text x="20" y="65" font-size="9" fill="#666">50</text>
                                    <text x="28" y="115" font-size="9" fill="#666">0</text>
                                    <line x1="40" y1="20" x2="190" y2="20" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                    <line x1="40" y1="65" x2="190" y2="65" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 右側カラム -->
            <div class="right-column">
                <!-- 出題項目別の成績 -->
                <section class="items-section">
                    <h2 class="section-title"><span class="diamond">◆</span>出題項目別の成績</h2>

                    <!-- 算数 -->
                    <div class="subject-block">
                        <div class="subject-header math-bg">
                            <span class="subject-name">算数</span>
                        </div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="q-col">大問</th>
                                    <th class="item-col">出題項目名</th>
                                    <th class="score-col">得点/配点</th>
                                    <th class="avg-col">学年平均点</th>
                                    <th class="rate-col">正答率</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in math_questions %}
                                <tr>
                                    <td>{{ question.number }}</td>
                                    <td>{{ question.title }}</td>
                                    <td>{{ question.score }}/{{ question.max_score }}<span class="unit">点</span></td>
                                    <td>{{ question.grade_avg }}<span class="unit">点</span></td>
                                    <td class="rate-cell">
                                        <div class="rate-container">
                                            <div class="rate-bar math-bar" style="width: {{ question.correct_rate }}%;"></div>
                                            <div class="avg-star" style="left: {{ question.grade_avg_rate }}%;">★</div>
                                            <span class="rate-text">{{ question.correct_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="chart-note">は出題項目別の正答率です。<span class="note-star">★</span>は学年の平均正答率です。</p>
                    </div>

                    <!-- 国語 -->
                    <div class="subject-block">
                        <div class="subject-header japanese-bg">
                            <span class="subject-name">国語</span>
                        </div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="q-col">大問</th>
                                    <th class="item-col">出題項目名</th>
                                    <th class="score-col">得点/配点</th>
                                    <th class="avg-col">学年平均点</th>
                                    <th class="rate-col">正答率</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in japanese_questions %}
                                <tr>
                                    <td>{{ question.number }}</td>
                                    <td>{{ question.title }}</td>
                                    <td>{{ question.score }}/{{ question.max_score }}<span class="unit">点</span></td>
                                    <td>{{ question.grade_avg }}<span class="unit">点</span></td>
                                    <td class="rate-cell">
                                        <div class="rate-container">
                                            <div class="rate-bar japanese-bar" style="width: {{ question.correct_rate }}%;"></div>
                                            <div class="avg-star" style="left: {{ question.grade_avg_rate }}%;">★</div>
                                            <span class="rate-text">{{ question.correct_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="chart-note">は出題項目別の正答率です。<span class="note-star">★</span>は学年の平均正答率です。</p>
                    </div>
                </section>

                <!-- 塾長からのコメント -->
                <section class="comment-section">
                    <h2 class="section-title"><span class="diamond">◆</span>塾長からのコメント</h2>

                    <div class="comment-grid">
                        <div class="comment-box math-comment">
                            <div class="comment-header math-bg">算数</div>
                            <p class="comment-text">{{ principal_math_comment }}</p>
                        </div>

                        <div class="comment-box japanese-comment">
                            <div class="comment-header japanese-bg">国語</div>
                            <p class="comment-text">{{ principal_japanese_comment }}</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
    // 成績推移グラフ描画（棒グラフ版）
    (function() {
        const trends = {{ trends|safe }};
        if (!trends || trends.length === 0) return;

        function drawBarChart(svgId, scores, avgScore, color, maxScore = 100) {
            const svg = document.getElementById(svgId);
            if (!svg) return;

            const ns = "http://www.w3.org/2000/svg";

            // データポイントの計算
            const minScore = 0;
            const barWidth = 25;
            const spacing = 50;

            scores.forEach((score, index) => {
                const x = 60 + (index * spacing);
                const barHeight = ((score - minScore) / (maxScore - minScore)) * 90;
                const y = 110 - barHeight;

                // 棒グラフ
                const rect = document.createElementNS(ns, 'rect');
                rect.setAttribute('x', x - barWidth/2);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', color);
                rect.setAttribute('opacity', '0.8');
                svg.appendChild(rect);

                // 点数表示
                const scoreText = document.createElementNS(ns, 'text');
                scoreText.setAttribute('x', x);
                scoreText.setAttribute('y', y - 5);
                scoreText.setAttribute('text-anchor', 'middle');
                scoreText.setAttribute('font-size', '10');
                scoreText.setAttribute('fill', color);
                scoreText.setAttribute('font-weight', '700');
                scoreText.textContent = Math.round(score);
                svg.appendChild(scoreText);

                // 回数ラベル
                const labelText = document.createElementNS(ns, 'text');
                labelText.setAttribute('x', x);
                labelText.setAttribute('y', '130');
                labelText.setAttribute('text-anchor', 'middle');
                labelText.setAttribute('font-size', '10');
                labelText.setAttribute('fill', '#666');
                labelText.setAttribute('font-weight', '600');
                labelText.textContent = `${index + 1}回`;
                svg.appendChild(labelText);
            });

            // 学年平均の星印とライン
            const avgY = 110 - ((avgScore - minScore) / (maxScore - minScore)) * 90;
            scores.forEach((score, index) => {
                const x = 60 + (index * spacing);

                // 星印
                const star = document.createElementNS(ns, 'text');
                star.setAttribute('x', x);
                star.setAttribute('y', avgY + 4);
                star.setAttribute('text-anchor', 'middle');
                star.setAttribute('font-size', '14');
                star.setAttribute('fill', '#ffd700');
                star.setAttribute('filter', 'drop-shadow(0 0 2px rgba(0,0,0,0.3))');
                star.textContent = '★';
                svg.appendChild(star);

                // 星を線で繋ぐ（2回目以降）
                if (index > 0) {
                    const prevX = 60 + ((index - 1) * spacing);
                    const line = document.createElementNS(ns, 'line');
                    line.setAttribute('x1', prevX);
                    line.setAttribute('y1', avgY);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', avgY);
                    line.setAttribute('stroke', '#ffd700');
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('stroke-dasharray', '4,3');
                    svg.insertBefore(line, svg.firstChild);
                }
            });
        }

        const totalScores = trends.map(t => t.total_score || 0);
        const japaneseScores = trends.map(t => t.japanese_score || 0);
        const mathScores = trends.map(t => t.math_score || 0);

        drawBarChart('totalChart_{{ student_id }}', totalScores, {{ total_grade_avg }}, '#3498db', 200);
        drawBarChart('mathChart_{{ student_id }}', mathScores, {{ math_grade_avg }}, '#27ae60', 100);
        drawBarChart('japaneseChart_{{ student_id }}', japaneseScores, {{ japanese_grade_avg }}, '#e67e22', 100);
    })();
    </script>
</body>
</html>
