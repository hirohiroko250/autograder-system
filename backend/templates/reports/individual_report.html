<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人成績表</title>
    <style>
        @page {
            size: A3 landscape;
            margin: 10mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans CJK JP', 'Hiragino Sans', 'Yu Gothic', sans-serif;
            font-size: 9pt;
            line-height: 1.4;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 400mm;
        }

        /* ヘッダー */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8mm;
            padding-bottom: 3mm;
            border-bottom: 2px solid #333;
        }

        .logo {
            height: 12mm;
        }

        .title {
            font-size: 18pt;
            font-weight: bold;
            color: #333;
        }

        .issue-date {
            font-size: 8pt;
            color: #666;
        }

        /* テスト情報 */
        .test-info {
            font-size: 10pt;
            margin-bottom: 5mm;
            font-weight: bold;
        }

        /* 生徒情報テーブル */
        .student-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8mm;
        }

        .student-info-table th {
            background-color: #f0f0f0;
            font-size: 7pt;
            padding: 2mm 1mm;
            border: 1px solid #000;
            text-align: center;
            font-weight: bold;
        }

        .student-info-table td {
            font-size: 7pt;
            padding: 2mm 1mm;
            border: 1px solid #000;
            text-align: center;
        }

        /* メインコンテンツ */
        .main-content {
            display: flex;
            gap: 8mm;
        }

        .left-section {
            flex: 0 0 128mm;
        }

        .right-section {
            flex: 1;
        }

        /* 得点テーブル */
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8mm;
        }

        .score-table th {
            padding: 3mm 2mm;
            border: 1px solid #000;
            text-align: center;
            font-size: 8pt;
            font-weight: bold;
        }

        .score-table td {
            padding: 3mm 2mm;
            border: 1px solid #000;
            text-align: center;
            font-size: 8pt;
        }

        .score-table th.subject-header {
            color: white;
        }

        .score-table th.math {
            background-color: #00A650;
        }

        .score-table th.japanese {
            background-color: #FF8C00;
        }

        .score-table th.total {
            background-color: #00A0E9;
        }

        .score-table tr th:first-child {
            background-color: #f0f0f0;
            color: #333;
        }

        .score-table .score-row td {
            font-size: 12pt;
            font-weight: bold;
        }

        /* 横棒グラフセクション */
        .section-title {
            font-size: 9pt;
            font-weight: bold;
            margin-bottom: 4mm;
            padding-left: 3mm;
            border-left: 3mm solid #333;
        }

        .subject-section {
            margin-bottom: 6mm;
        }

        .subject-name {
            font-size: 8pt;
            font-weight: bold;
            margin-bottom: 2mm;
            padding: 1mm 2mm;
            display: inline-block;
        }

        .subject-name.math {
            background-color: #00A650;
            color: white;
        }

        .subject-name.japanese {
            background-color: #FF8C00;
            color: white;
        }

        .graph-header {
            display: grid;
            grid-template-columns: 15mm 50mm 25mm 25mm 25mm 1fr;
            font-size: 6pt;
            font-weight: bold;
            padding: 1mm 0;
            border-bottom: 1px solid #ccc;
            margin-bottom: 2mm;
        }

        .graph-row {
            display: grid;
            grid-template-columns: 15mm 50mm 25mm 25mm 25mm 1fr;
            align-items: center;
            font-size: 6pt;
            padding: 1.5mm 0;
        }

        .bar-chart {
            position: relative;
            height: 5mm;
            background-color: #f5f5f5;
            border: 0.5px solid #ccc;
        }

        .bar {
            height: 100%;
            position: relative;
        }

        .bar.math {
            background-color: #00A650;
        }

        .bar.japanese {
            background-color: #FF8C00;
        }

        .star-marker {
            position: absolute;
            top: -2mm;
            transform: translateX(-50%);
            color: red;
            font-size: 8pt;
        }

        /* コメントセクション */
        .comments-section {
            margin-top: 8mm;
        }

        .comment-box {
            margin-bottom: 5mm;
        }

        .comment-label {
            font-size: 7pt;
            font-weight: bold;
            margin-bottom: 1mm;
            padding: 1mm 2mm;
            display: inline-block;
        }

        .comment-label.math {
            background-color: #00A650;
            color: white;
        }

        .comment-label.japanese {
            background-color: #FF8C00;
            color: white;
        }

        .comment-text {
            font-size: 6pt;
            line-height: 1.6;
            padding: 2mm;
            background-color: #fafafa;
            border: 1px solid #e0e0e0;
            min-height: 12mm;
        }

        /* 推移セクション */
        .trend-section {
            margin-top: 6mm;
        }

        .trend-table {
            width: 50mm;
            border-collapse: collapse;
        }

        .trend-table th {
            background-color: #00A0E9;
            color: white;
            padding: 2mm;
            border: 1px solid #000;
            font-size: 6pt;
            text-align: center;
        }

        .trend-table td {
            padding: 2mm;
            border: 1px solid #000;
            font-size: 6pt;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <img src="{{ logo_url }}" alt="ロゴ" class="logo">
            <div class="title">全国学力向上テスト  個人成績表</div>
            <div class="issue-date">発行日：{{ issue_date }}</div>
        </div>

        <!-- テスト情報 -->
        <div class="test-info">
            {{ test_year }}年度  第{{ test_iteration }}回  学年 小{{ student_grade }}
        </div>

        <!-- 生徒情報テーブル -->
        <table class="student-info-table">
            <tr>
                <th>塾ID</th>
                <td>{{ school_id }}</td>
                <th>塾名</th>
                <td>{{ school_name }}</td>
                <th>生徒ID</th>
                <td>{{ student_id }}</td>
                <th>受験ID</th>
                <td>{{ student_id }}</td>
                <th>学年</th>
                <td>{{ student_grade }}</td>
                <th>生徒氏名</th>
                <td>{{ student_name }}</td>
            </tr>
        </table>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- 左側：得点テーブル -->
            <div class="left-section">
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>教科</th>
                            <th class="subject-header math">算数</th>
                            <th class="subject-header japanese">国語</th>
                            <th class="subject-header total">合計</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="score-row">
                            <th>得点</th>
                            <td>{{ math_score }}点</td>
                            <td>{{ japanese_score }}点</td>
                            <td>{{ total_score }}点</td>
                        </tr>
                        <tr>
                            <th>偏差値</th>
                            <td>{{ math_deviation }}</td>
                            <td>{{ japanese_deviation }}</td>
                            <td>{{ total_deviation }}</td>
                        </tr>
                        <tr>
                            <th>全国順位（受験者数）</th>
                            <td>{{ math_national_rank }}位({{ math_national_total }}人中)</td>
                            <td>{{ japanese_national_rank }}位({{ japanese_national_total }}人中)</td>
                            <td>{{ total_national_rank }}位({{ total_national_total }}人中)</td>
                        </tr>
                        <tr>
                            <th>塾内順位（受験者数）</th>
                            <td>{{ math_school_rank }}位({{ math_school_total }}人中)</td>
                            <td>{{ japanese_school_rank }}位({{ japanese_school_total }}人中)</td>
                            <td>{{ total_school_rank }}位({{ total_school_total }}人中)</td>
                        </tr>
                        <tr>
                            <th>最高点（全国）</th>
                            <td>{{ math_national_highest }}点</td>
                            <td>{{ japanese_national_highest }}点</td>
                            <td>{{ total_national_highest }}点</td>
                        </tr>
                        <tr>
                            <th>最高点（塾内）</th>
                            <td>{{ math_school_highest }}点</td>
                            <td>{{ japanese_school_highest }}点</td>
                            <td>{{ total_school_highest }}点</td>
                        </tr>
                        <tr>
                            <th>平均点（全国）</th>
                            <td>{{ math_national_avg }}点</td>
                            <td>{{ japanese_national_avg }}点</td>
                            <td>{{ total_national_avg }}点</td>
                        </tr>
                        <tr>
                            <th>平均点（塾内）</th>
                            <td>{{ math_school_avg }}点</td>
                            <td>{{ japanese_school_avg }}点</td>
                            <td>{{ total_school_avg }}点</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 右側：横棒グラフ -->
            <div class="right-section">
                <div class="section-title">◆出題項目別の成績</div>

                <!-- 算数 -->
                <div class="subject-section">
                    <div class="subject-name math">算数</div>
                    <div class="graph-header">
                        <div>大問</div>
                        <div>出題項目名</div>
                        <div>得点/配点</div>
                        <div>全国平均点</div>
                        <div>正答率</div>
                        <div style="padding-left: 10mm;">0%   20%   40%   60%   80%  100%</div>
                    </div>
                    {% for question in math_questions %}
                    <div class="graph-row">
                        <div>{{ question.number }}</div>
                        <div>{{ question.title }}</div>
                        <div>{{ question.score }}/{{ question.max_score }}</div>
                        <div>{{ question.national_avg }}</div>
                        <div>{{ question.correct_rate }}%</div>
                        <div class="bar-chart">
                            <div class="bar math" style="width: {{ question.correct_rate }}%;"></div>
                            <span class="star-marker" style="left: {{ question.national_avg_rate }}%;">★</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- 国語 -->
                <div class="subject-section">
                    <div class="subject-name japanese">国語</div>
                    <div class="graph-header">
                        <div>大問</div>
                        <div>出題項目名</div>
                        <div>得点/配点</div>
                        <div>全国平均点</div>
                        <div>正答率</div>
                        <div style="padding-left: 10mm;">0%   20%   40%   60%   80%  100%</div>
                    </div>
                    {% for question in japanese_questions %}
                    <div class="graph-row">
                        <div>{{ question.number }}</div>
                        <div>{{ question.title }}</div>
                        <div>{{ question.score }}/{{ question.max_score }}</div>
                        <div>{{ question.national_avg }}</div>
                        <div>{{ question.correct_rate }}%</div>
                        <div class="bar-chart">
                            <div class="bar japanese" style="width: {{ question.correct_rate }}%;"></div>
                            <span class="star-marker" style="left: {{ question.national_avg_rate }}%;">★</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- コメントセクション -->
        <div class="comments-section">
            <div style="display: flex; gap: 8mm;">
                <!-- 教科ごとの総評 -->
                <div style="flex: 1;">
                    <div class="section-title">◆教科ごとの総評</div>
                    <div class="comment-box">
                        <div class="comment-label math">算数</div>
                        <div class="comment-text">{{ math_comment }}</div>
                    </div>
                    <div class="comment-box">
                        <div class="comment-label japanese">国語</div>
                        <div class="comment-text">{{ japanese_comment }}</div>
                    </div>
                </div>

                <!-- 塾長からのコメント -->
                <div style="flex: 1;">
                    <div class="section-title">◆塾長からのコメント</div>
                    <div class="comment-box">
                        <div class="comment-label math">算数</div>
                        <div class="comment-text">{{ principal_math_comment }}</div>
                    </div>
                    <div class="comment-box">
                        <div class="comment-label japanese">国語</div>
                        <div class="comment-text">{{ principal_japanese_comment }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 成績の推移 -->
        <div class="trend-section">
            <div class="section-title">◆成績の推移</div>
            <table class="trend-table">
                <thead>
                    <tr>
                        <th>回数</th>
                        <th>得点</th>
                        <th>偏差値</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trend in trends %}
                    <tr>
                        <td>{{ trend.iteration }}</td>
                        <td>{{ trend.score }}</td>
                        <td>{{ trend.deviation }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
