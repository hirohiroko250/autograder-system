<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>個人成績表</title>
    <style>
        @page {
            size: A3 landscape;
            margin: 8mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans CJK JP', 'Hiragino Sans', 'Yu Gothic', sans-serif;
            font-size: 8pt;
            line-height: 1.3;
            color: #333;
            width: 404mm;
            height: 277mm;
        }

        .container {
            width: 100%;
            height: 100%;
            padding: 5mm;
        }

        /* ヘッダー */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3mm;
            padding-bottom: 2mm;
            border-bottom: 2px solid #333;
        }

        .logo {
            height: 15mm;
            width: auto;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .title {
            font-size: 18pt;
            font-weight: bold;
            margin-bottom: 2mm;
        }

        .test-info {
            font-size: 10pt;
            font-weight: bold;
        }

        /* 窓開き用エリア（左上） */
        .window-area {
            position: absolute;
            left: 25mm;
            top: 25mm;
            width: 90mm;
            height: 45mm;
            border: 1px dashed #ccc;
            padding: 5mm;
            background-color: #f9f9f9;
        }

        .window-label {
            font-size: 6pt;
            color: #999;
            margin-bottom: 2mm;
        }

        .window-content {
            font-size: 9pt;
            line-height: 1.6;
        }

        .window-content .school-name {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 1mm;
        }

        .window-content .student-name {
            font-size: 14pt;
            font-weight: bold;
            margin-top: 3mm;
        }

        /* 右上の発行日 */
        .issue-date {
            font-size: 7pt;
            color: #666;
            text-align: right;
        }

        /* 生徒情報（窓開きの右側に配置） */
        .student-info-section {
            margin-left: 125mm;
            margin-top: 5mm;
            margin-bottom: 5mm;
        }

        .student-info {
            width: 100%;
            border-collapse: collapse;
        }

        .student-info th {
            background-color: #f0f0f0;
            font-size: 6pt;
            padding: 1mm;
            border: 1px solid #000;
            font-weight: bold;
            width: 15%;
        }

        .student-info td {
            font-size: 6pt;
            padding: 1mm;
            border: 1px solid #000;
            width: 18%;
        }

        /* メインコンテンツ */
        .main-content {
            display: flex;
            gap: 5mm;
            margin-top: 3mm;
        }

        .left-section {
            flex: 0 0 115mm;
        }

        .right-section {
            flex: 1;
        }

        /* 得点テーブル */
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 3mm;
        }

        .score-table th, .score-table td {
            padding: 1.5mm 1mm;
            border: 1px solid #000;
            text-align: center;
            font-size: 6pt;
        }

        .score-table th.subject-header {
            color: white;
            font-size: 7pt;
        }

        .score-table th.math {
            background-color: #00A650;
        }

        .score-table th.japanese {
            background-color: #FF8C00;
        }

        .score-table th.total {
            background-color: #00A0E9;
        }

        .score-table tr th:first-child {
            background-color: #f0f0f0;
            color: #333;
            font-size: 6pt;
        }

        .score-table .score-row td {
            font-size: 10pt;
            font-weight: bold;
        }

        /* セクションタイトル */
        .section-title {
            font-size: 7pt;
            font-weight: bold;
            margin-bottom: 2mm;
            padding-left: 2mm;
            border-left: 2mm solid #333;
        }

        /* 横棒グラフ */
        .subject-section {
            margin-bottom: 3mm;
        }

        .subject-name {
            font-size: 7pt;
            font-weight: bold;
            margin-bottom: 1mm;
            padding: 0.5mm 1.5mm;
            display: inline-block;
            color: white;
        }

        .subject-name.math {
            background-color: #00A650;
        }

        .subject-name.japanese {
            background-color: #FF8C00;
        }

        .graph-legend {
            font-size: 5pt;
            color: #666;
            margin-bottom: 1mm;
            padding-left: 2mm;
        }

        .graph-legend .star {
            color: red;
            font-weight: bold;
        }

        .graph-header, .graph-row {
            display: grid;
            grid-template-columns: 12mm 42mm 18mm 18mm 16mm 1fr;
            font-size: 5pt;
            padding: 1mm 0;
        }

        .graph-header {
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            margin-bottom: 1mm;
        }

        .bar-chart {
            position: relative;
            height: 4mm;
            background-color: #f5f5f5;
            border: 0.5px solid #ccc;
        }

        .bar {
            height: 100%;
        }

        .bar.math {
            background-color: #00A650;
        }

        .bar.japanese {
            background-color: #FF8C00;
        }

        .star-marker {
            position: absolute;
            top: -1.5mm;
            transform: translateX(-50%);
            color: red;
            font-size: 6pt;
        }

        /* コメント・推移セクション */
        .bottom-section {
            display: flex;
            gap: 5mm;
            margin-top: 3mm;
        }

        .comments-section {
            flex: 1;
        }

        .comments-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3mm;
        }

        .comment-column {
            display: flex;
            flex-direction: column;
            gap: 2mm;
        }

        .comment-box {
            flex: 1;
        }

        .comment-label {
            font-size: 6pt;
            font-weight: bold;
            padding: 0.5mm 1.5mm;
            display: inline-block;
            color: white;
            margin-bottom: 1mm;
        }

        .comment-label.math {
            background-color: #00A650;
        }

        .comment-label.japanese {
            background-color: #FF8C00;
        }

        .comment-text {
            font-size: 5pt;
            line-height: 1.5;
            padding: 2mm;
            background-color: #fafafa;
            border: 1px solid #e0e0e0;
            height: 100%;
            min-height: 15mm;
        }

        .trend-section {
            flex: 0 0 85mm;
        }

        /* 成績推移グラフ */
        .trend-chart {
            position: relative;
            height: 50mm;
            border: 1px solid #ccc;
            background: linear-gradient(to right, #f9f9f9 0%, #f9f9f9 100%);
            padding: 3mm;
            margin-top: 2mm;
        }

        .chart-grid {
            position: absolute;
            top: 3mm;
            left: 15mm;
            right: 3mm;
            bottom: 8mm;
        }

        .chart-grid-line {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px dashed #ddd;
        }

        .chart-y-label {
            position: absolute;
            left: -12mm;
            font-size: 5pt;
            color: #666;
        }

        .chart-x-axis {
            position: absolute;
            bottom: 5mm;
            left: 15mm;
            right: 3mm;
            display: flex;
            justify-content: space-between;
        }

        .chart-x-label {
            font-size: 5pt;
            color: #666;
        }

        .chart-line {
            position: absolute;
            top: 3mm;
            left: 15mm;
            right: 3mm;
            bottom: 8mm;
        }

        .chart-point {
            position: absolute;
            width: 4mm;
            height: 4mm;
            background-color: #00A0E9;
            border: 2px solid #fff;
            border-radius: 50%;
            transform: translate(-2mm, -2mm);
        }

        .chart-label {
            position: absolute;
            font-size: 5pt;
            color: #333;
            font-weight: bold;
            transform: translate(-3mm, -6mm);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 窓開きエリア -->
        <div class="window-area">
            <div class="window-label">※窓開き封筒対応エリア</div>
            <div class="window-content">
                <div class="school-name">{{ school_name }}</div>
                <div>{{ school_id }}</div>
                <div class="student-name">{{ student_name }} 様</div>
            </div>
        </div>

        <!-- ヘッダー -->
        <div class="header">
            <img src="{{ logo_url }}" alt="ロゴ" class="logo">
            <div class="header-center">
                <div class="title">全国学力向上テスト  個人成績表</div>
                <div class="test-info">
                    {{ test_year }}年度  第{{ test_iteration }}回  学年 小{{ student_grade }}
                </div>
            </div>
            <div class="issue-date">発行日：{{ issue_date }}</div>
        </div>

        <!-- 生徒情報（窓開きの右側） -->
        <div class="student-info-section">
            <table class="student-info">
                <tr>
                    <th>塾ID</th>
                    <td>{{ school_id }}</td>
                    <th>生徒ID</th>
                    <td>{{ student_id }}</td>
                    <th>受験ID</th>
                    <td>{{ student_id }}</td>
                </tr>
            </table>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- 左側：得点テーブル -->
            <div class="left-section">
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>教科</th>
                            <th class="subject-header math">算数</th>
                            <th class="subject-header japanese">国語</th>
                            <th class="subject-header total">合計</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="score-row">
                            <th>得点</th>
                            <td>{{ math_score }}点</td>
                            <td>{{ japanese_score }}点</td>
                            <td>{{ total_score }}点</td>
                        </tr>
                        <tr>
                            <th>偏差値</th>
                            <td>{{ math_deviation }}</td>
                            <td>{{ japanese_deviation }}</td>
                            <td>{{ total_deviation }}</td>
                        </tr>
                        <tr>
                            <th>全国順位（受験者数）</th>
                            <td>{{ math_national_rank }}位({{ math_national_total }}人中)</td>
                            <td>{{ japanese_national_rank }}位({{ japanese_national_total }}人中)</td>
                            <td>{{ total_national_rank }}位({{ total_national_total }}人中)</td>
                        </tr>
                        <tr>
                            <th>塾内順位（受験者数）</th>
                            <td>{{ math_school_rank }}位({{ math_school_total }}人中)</td>
                            <td>{{ japanese_school_rank }}位({{ japanese_school_total }}人中)</td>
                            <td>{{ total_school_rank }}位({{ total_school_total }}人中)</td>
                        </tr>
                        <tr>
                            <th>最高点（全国）</th>
                            <td>{{ math_national_highest }}点</td>
                            <td>{{ japanese_national_highest }}点</td>
                            <td>{{ total_national_highest }}点</td>
                        </tr>
                        <tr>
                            <th>最高点（塾内）</th>
                            <td>{{ math_school_highest }}点</td>
                            <td>{{ japanese_school_highest }}点</td>
                            <td>{{ total_school_highest }}点</td>
                        </tr>
                        <tr>
                            <th>平均点（全国）</th>
                            <td>{{ math_national_avg }}点</td>
                            <td>{{ japanese_national_avg }}点</td>
                            <td>{{ total_national_avg }}点</td>
                        </tr>
                        <tr>
                            <th>平均点（塾内）</th>
                            <td>{{ math_school_avg }}点</td>
                            <td>{{ japanese_school_avg }}点</td>
                            <td>{{ total_school_avg }}点</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 右側：横棒グラフ -->
            <div class="right-section">
                <div class="section-title">◆出題項目別の成績</div>
                <div class="graph-legend">
                    <span class="star">★</span>は全国平均を示します
                </div>

                <!-- 算数 -->
                <div class="subject-section">
                    <div class="subject-name math">算数</div>
                    <div class="graph-header">
                        <div>大問</div>
                        <div>出題項目名</div>
                        <div>得点/配点</div>
                        <div>全国平均点</div>
                        <div>正答率</div>
                        <div style="padding-left: 6mm;">0%   20%   40%   60%   80%  100%</div>
                    </div>
                    {% for question in math_questions %}
                    <div class="graph-row">
                        <div>{{ question.number }}</div>
                        <div>{{ question.title }}</div>
                        <div>{{ question.score }}/{{ question.max_score }}</div>
                        <div>{{ question.national_avg }}</div>
                        <div>{{ question.correct_rate }}%</div>
                        <div class="bar-chart">
                            <div class="bar math" style="width: {{ question.correct_rate }}%;"></div>
                            <span class="star-marker" style="left: {{ question.national_avg_rate }}%;">★</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- 国語 -->
                <div class="subject-section">
                    <div class="subject-name japanese">国語</div>
                    <div class="graph-header">
                        <div>大問</div>
                        <div>出題項目名</div>
                        <div>得点/配点</div>
                        <div>全国平均点</div>
                        <div>正答率</div>
                        <div style="padding-left: 6mm;">0%   20%   40%   60%   80%  100%</div>
                    </div>
                    {% for question in japanese_questions %}
                    <div class="graph-row">
                        <div>{{ question.number }}</div>
                        <div>{{ question.title }}</div>
                        <div>{{ question.score }}/{{ question.max_score }}</div>
                        <div>{{ question.national_avg }}</div>
                        <div>{{ question.correct_rate }}%</div>
                        <div class="bar-chart">
                            <div class="bar japanese" style="width: {{ question.correct_rate }}%;"></div>
                            <span class="star-marker" style="left: {{ question.national_avg_rate }}%;">★</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- コメントと推移 -->
        <div class="bottom-section">
            <div class="comments-section">
                <div class="comments-grid">
                    <!-- 教科ごとの総評 -->
                    <div class="comment-column">
                        <div class="section-title">◆教科ごとの総評</div>
                        <div class="comment-box">
                            <div class="comment-label math">算数</div>
                            <div class="comment-text">{{ math_comment }}</div>
                        </div>
                        <div class="comment-box">
                            <div class="comment-label japanese">国語</div>
                            <div class="comment-text">{{ japanese_comment }}</div>
                        </div>
                    </div>

                    <!-- 塾長からのコメント -->
                    <div class="comment-column">
                        <div class="section-title">◆塾長からのコメント</div>
                        <div class="comment-box">
                            <div class="comment-label math">算数</div>
                            <div class="comment-text">{{ principal_math_comment }}</div>
                        </div>
                        <div class="comment-box">
                            <div class="comment-label japanese">国語</div>
                            <div class="comment-text">{{ principal_japanese_comment }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 成績推移 -->
            <div class="trend-section">
                <div class="section-title">◆成績の推移</div>
                <div class="trend-chart">
                    <div class="chart-grid">
                        <!-- グリッドライン -->
                        <div class="chart-grid-line" style="bottom: 0%;">
                            <span class="chart-y-label">0</span>
                        </div>
                        <div class="chart-grid-line" style="bottom: 25%;">
                            <span class="chart-y-label">25</span>
                        </div>
                        <div class="chart-grid-line" style="bottom: 50%;">
                            <span class="chart-y-label">50</span>
                        </div>
                        <div class="chart-grid-line" style="bottom: 75%;">
                            <span class="chart-y-label">75</span>
                        </div>
                        <div class="chart-grid-line" style="bottom: 100%;">
                            <span class="chart-y-label">100</span>
                        </div>
                    </div>

                    <!-- データポイント -->
                    <div class="chart-line">
                        {% for trend in trends %}
                        {% if trend.score > 0 %}
                        <div class="chart-point" style="left: {{ loop.index0 * 33.3 }}%; bottom: {{ trend.score }}%;">
                            <div class="chart-label">{{ trend.score }}</div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                    <!-- X軸ラベル -->
                    <div class="chart-x-axis">
                        {% for trend in trends %}
                        <div class="chart-x-label">第{{ trend.iteration }}回</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
