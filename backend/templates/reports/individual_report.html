<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人成績表 - 全国学力向上テスト</title>
    <style>
{{ css_content|safe }}
    </style>
</head>
<body>
    <div class="report-page">
        <!-- ヘッダー -->
        <header class="header">
            <div class="logo">
                <img src="/static/reports/logo.png" alt="全国学力向上テスト">
            </div>
            <div class="header-right">
                <p class="issue-date">発行日：{{ issue_date }}</p>
                <div class="test-info">
                    <span class="info-label">学年</span>
                    <span class="info-value">{{ student_grade }}</span>
                    <span class="info-label">第</span>
                    <span class="info-value">{{ test_iteration }}</span>
                    <span class="info-label">回</span>
                    <span class="info-label">年度</span>
                    <span class="info-value">{{ test_year }}</span>
                </div>
                <h1 class="main-title">個人成績表</h1>
            </div>
        </header>

        <!-- 窓あき封筒用エリアと生徒情報 -->
        <div class="top-area">
            <!-- 窓あき封筒用 -->
            <div class="window-area">
                <div class="window-frame">
                    <div class="window-content">
                        <p class="address-line">〒000-0000</p>
                        <p class="address-line">{{ school_name }}</p>
                        <p class="student-name">{{ student_name }}　様</p>
                    </div>
                </div>
            </div>

            <!-- 生徒情報 -->
            <div class="student-info">
                <div class="info-row">
                    <div class="info-item">
                        <span class="label">生徒氏名</span>
                        <span class="value">{{ student_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">学年</span>
                        <span class="value">{{ student_grade }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">受験ID</span>
                        <span class="value">{{ student_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">生徒ID</span>
                        <span class="value">{{ student_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">塾名</span>
                        <span class="value">{{ school_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">塾ID</span>
                        <span class="value">{{ school_id }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-layout">
            <!-- 左側カラム -->
            <div class="left-column">
                <!-- 得点・偏差値・順位 -->
                <section class="score-section">
                    <h2 class="section-title"><span class="diamond">◆</span>得点・偏差値・順位</h2>

                    <table class="score-table">
                        <thead>
                            <tr>
                                <th class="label-col">教科</th>
                                <th class="total-col">合計</th>
                                <th class="japanese-col">国語</th>
                                <th class="math-col">算数</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">得点</td>
                                <td class="total-cell">{{ total_score }}<span class="unit">点</span></td>
                                <td class="japanese-cell">{{ japanese_score }}<span class="unit">点</span></td>
                                <td class="math-cell">{{ math_score }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">偏差値</td>
                                <td class="total-cell">{{ total_deviation }}</td>
                                <td class="japanese-cell">{{ japanese_deviation }}</td>
                                <td class="math-cell">{{ math_deviation }}</td>
                            </tr>
                            <tr>
                                <td class="label-cell">全国順位<br><span class="sub-label">(受験者数)</span></td>
                                <td class="total-cell">{{ total_national_rank }}<span class="unit">位</span><br><span class="sub-value">({{ total_national_total }}人中)</span></td>
                                <td class="japanese-cell">{{ japanese_national_rank }}<span class="unit">位</span><br><span class="sub-value">({{ japanese_national_total }}人中)</span></td>
                                <td class="math-cell">{{ math_national_rank }}<span class="unit">位</span><br><span class="sub-value">({{ math_national_total }}人中)</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">塾内順位<br><span class="sub-label">(受験者数)</span></td>
                                <td class="total-cell">{{ total_school_rank }}<span class="unit">位</span><br><span class="sub-value">({{ total_school_total }}人中)</span></td>
                                <td class="japanese-cell">{{ japanese_school_rank }}<span class="unit">位</span><br><span class="sub-value">({{ japanese_school_total }}人中)</span></td>
                                <td class="math-cell">{{ math_school_rank }}<span class="unit">位</span><br><span class="sub-value">({{ math_school_total }}人中)</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">最高点<br><span class="sub-label">(全国)</span></td>
                                <td>{{ total_national_highest }}<span class="unit">点</span></td>
                                <td>{{ japanese_national_highest }}<span class="unit">点</span></td>
                                <td>{{ math_national_highest }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">最高点<br><span class="sub-label">(塾内)</span></td>
                                <td>{{ total_school_highest }}<span class="unit">点</span></td>
                                <td>{{ japanese_school_highest }}<span class="unit">点</span></td>
                                <td>{{ math_school_highest }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">平均点<br><span class="sub-label">(全国)</span></td>
                                <td>{{ total_national_avg }}<span class="unit">点</span></td>
                                <td>{{ japanese_national_avg }}<span class="unit">点</span></td>
                                <td>{{ math_national_avg }}<span class="unit">点</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">平均点<br><span class="sub-label">(塾内)</span></td>
                                <td>{{ total_school_avg }}<span class="unit">点</span></td>
                                <td>{{ japanese_school_avg }}<span class="unit">点</span></td>
                                <td>{{ math_school_avg }}<span class="unit">点</span></td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- 成績の推移 -->
                <section class="trend-section">
                    <h2 class="section-title"><span class="diamond">◆</span>成績の推移</h2>

                    <div class="trend-graphs">
                        <!-- 全教科 -->
                        <div class="trend-graph total-graph">
                            <div class="graph-header total-bg">全教科</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 120" class="line-chart" id="totalChart">
                                    <!-- グリッド線 -->
                                    <line x1="30" y1="20" x2="30" y2="100" stroke="#e0e0e0" stroke-width="1"/>
                                    <line x1="30" y1="100" x2="190" y2="100" stroke="#e0e0e0" stroke-width="1"/>
                                </svg>
                            </div>
                        </div>

                        <!-- 算数 -->
                        <div class="trend-graph math-graph">
                            <div class="graph-header math-bg">算数</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 120" class="line-chart" id="mathChart">
                                    <line x1="30" y1="20" x2="30" y2="100" stroke="#e0e0e0" stroke-width="1"/>
                                    <line x1="30" y1="100" x2="190" y2="100" stroke="#e0e0e0" stroke-width="1"/>
                                </svg>
                            </div>
                        </div>

                        <!-- 国語 -->
                        <div class="trend-graph japanese-graph">
                            <div class="graph-header japanese-bg">国語</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 120" class="line-chart" id="japaneseChart">
                                    <line x1="30" y1="20" x2="30" y2="100" stroke="#e0e0e0" stroke-width="1"/>
                                    <line x1="30" y1="100" x2="190" y2="100" stroke="#e0e0e0" stroke-width="1"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 右側カラム -->
            <div class="right-column">
                <!-- 出題項目別の成績 -->
                <section class="items-section">
                    <h2 class="section-title"><span class="diamond">◆</span>出題項目別の成績</h2>

                    <!-- 算数 -->
                    <div class="subject-block">
                        <div class="subject-header math-bg">
                            <span class="subject-name">算数</span>
                        </div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="q-col">大問</th>
                                    <th class="item-col">出題項目名</th>
                                    <th class="score-col">得点/配点</th>
                                    <th class="avg-col">全国平均点</th>
                                    <th class="rate-col">正答率</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in math_questions %}
                                <tr>
                                    <td>{{ question.number }}</td>
                                    <td>{{ question.title }}</td>
                                    <td>{{ question.score }}/{{ question.max_score }}<span class="unit">点</span></td>
                                    <td>{{ question.national_avg }}<span class="unit">点</span></td>
                                    <td class="rate-cell">
                                        <div class="rate-container">
                                            <div class="rate-bar math-bar" style="width: {{ question.correct_rate }}%;"></div>
                                            <div class="avg-star" style="left: {{ question.national_avg_rate }}%;">★</div>
                                            <span class="rate-text">{{ question.correct_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="chart-note">は出題項目別の正答率です。<span class="note-star">★</span>は全国の平均正答率です。</p>
                    </div>

                    <!-- 国語 -->
                    <div class="subject-block">
                        <div class="subject-header japanese-bg">
                            <span class="subject-name">国語</span>
                        </div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="q-col">大問</th>
                                    <th class="item-col">出題項目名</th>
                                    <th class="score-col">得点/配点</th>
                                    <th class="avg-col">全国平均点</th>
                                    <th class="rate-col">正答率</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in japanese_questions %}
                                <tr>
                                    <td>{{ question.number }}</td>
                                    <td>{{ question.title }}</td>
                                    <td>{{ question.score }}/{{ question.max_score }}<span class="unit">点</span></td>
                                    <td>{{ question.national_avg }}<span class="unit">点</span></td>
                                    <td class="rate-cell">
                                        <div class="rate-container">
                                            <div class="rate-bar japanese-bar" style="width: {{ question.correct_rate }}%;"></div>
                                            <div class="avg-star" style="left: {{ question.national_avg_rate }}%;">★</div>
                                            <span class="rate-text">{{ question.correct_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="chart-note">は出題項目別の正答率です。<span class="note-star">★</span>は全国の平均正答率です。</p>
                    </div>
                </section>

                <!-- 塾長からのコメント -->
                <section class="comment-section">
                    <h2 class="section-title"><span class="diamond">◆</span>塾長からのコメント</h2>

                    <div class="comment-grid">
                        <div class="comment-box math-comment">
                            <div class="comment-header math-bg">算数</div>
                            <p class="comment-text">{{ principal_math_comment }}</p>
                        </div>

                        <div class="comment-box japanese-comment">
                            <div class="comment-header japanese-bg">国語</div>
                            <p class="comment-text">{{ principal_japanese_comment }}</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
    // 成績推移グラフ描画（SVG版）
    (function() {
        const trends = {{ trends|safe }};
        if (!trends || trends.length === 0) return;

        function drawSVGChart(svgId, scores, avgScores, color, avgColor) {
            const svg = document.getElementById(svgId);
            if (!svg) return;

            const ns = "http://www.w3.org/2000/svg";

            // データポイントの計算
            const maxScore = 100;
            const minScore = 0;
            const points = [];
            const avgPoints = [];

            scores.forEach((score, index) => {
                const x = 70 + (index * 40);
                const y = 100 - ((score - minScore) / (maxScore - minScore)) * 80;
                points.push({ x, y, score });
            });

            avgScores.forEach((score, index) => {
                const x = 70 + (index * 40);
                const y = 100 - ((score - minScore) / (maxScore - minScore)) * 80;
                avgPoints.push({ x, y });
            });

            // 全国平均ライン（点線）
            if (avgPoints.length > 1) {
                for (let i = 0; i < avgPoints.length - 1; i++) {
                    const line = document.createElementNS(ns, 'line');
                    line.setAttribute('x1', avgPoints[i].x);
                    line.setAttribute('y1', avgPoints[i].y);
                    line.setAttribute('x2', avgPoints[i + 1].x);
                    line.setAttribute('y2', avgPoints[i + 1].y);
                    line.setAttribute('stroke', avgColor);
                    line.setAttribute('stroke-width', '1');
                    line.setAttribute('stroke-dasharray', '3,3');
                    svg.appendChild(line);
                }
            }

            // データライン
            if (points.length > 0) {
                const polyline = document.createElementNS(ns, 'polyline');
                const pointsStr = points.map(p => `${p.x},${p.y}`).join(' ');
                polyline.setAttribute('points', pointsStr);
                polyline.setAttribute('fill', 'none');
                polyline.setAttribute('stroke', color);
                polyline.setAttribute('stroke-width', '3');
                svg.appendChild(polyline);
            }

            // データポイント
            points.forEach(point => {
                const circle = document.createElementNS(ns, 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', '4');
                circle.setAttribute('fill', color);
                svg.appendChild(circle);
            });

            // 全国平均ポイント
            avgPoints.forEach(point => {
                const circle = document.createElementNS(ns, 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', '3');
                circle.setAttribute('fill', avgColor);
                svg.appendChild(circle);
            });

            // 軸ラベル
            points.forEach((point, index) => {
                const text = document.createElementNS(ns, 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', '115');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '10');
                text.setAttribute('fill', '#666');
                text.textContent = `${index + 1}回`;
                svg.appendChild(text);
            });

            // 値
            points.forEach(point => {
                const text = document.createElementNS(ns, 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', point.y - 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '9');
                text.setAttribute('fill', color);
                text.setAttribute('font-weight', '700');
                text.textContent = Math.round(point.score);
                svg.appendChild(text);
            });
        }

        const totalScores = trends.map(t => t.total_score || 0);
        const japaneseScores = trends.map(t => t.japanese_score || 0);
        const mathScores = trends.map(t => t.math_score || 0);

        const totalAvgs = trends.map(t => {{ total_national_avg }});
        const japaneseAvgs = trends.map(t => {{ japanese_national_avg }});
        const mathAvgs = trends.map(t => {{ math_national_avg }});

        drawSVGChart('totalChart', totalScores, totalAvgs, '#3498db', '#95a5a6');
        drawSVGChart('mathChart', mathScores, mathAvgs, '#27ae60', '#95a5a6');
        drawSVGChart('japaneseChart', japaneseScores, japaneseAvgs, '#e67e22', '#95a5a6');
    })();
    </script>
</body>
</html>
