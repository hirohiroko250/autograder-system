{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:students_student_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="form-row">
    <div class="align-left">
        <p>生徒の包括的なテストデータをエクセルファイルでエクスポートします。</p>
        <p><strong>現在の生徒数:</strong> {{ student_count }}名</p>
    </div>
</div>

<form action="" method="post">
    {% csrf_token %}
    
    <fieldset class="module aligned">
        <h2>エクスポート条件</h2>
        
        <div class="form-row">
            <div>
                <label for="id_year" class="required">年度:</label>
                <select name="year" id="id_year" required>
                    {% for year in years %}
                        <option value="{{ year.value }}"{% if year.value == 'all' %} selected{% endif %}>{{ year.label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div>
                <label for="id_period" class="required">期間:</label>
                <select name="period" id="id_period" required>
                    {% for period in periods %}
                        <option value="{{ period.value }}"{% if period.value == 'all' %} selected{% endif %}>{{ period.label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </fieldset>
    
    <div class="submit-row">
        <input type="submit" value="エクスポート実行" class="default" />
        <a href="{% url 'admin:students_student_changelist' %}" class="button cancel-link">キャンセル</a>
    </div>
</form>

<div class="form-row">
    <div class="help">
        <p><strong>エクスポート内容:</strong></p>
        <ul>
            <li><strong>基本情報:</strong> 塾ID・塾名・教室ID・教室名・生徒ID・生徒名・学年</li>
            <li><strong>テスト情報:</strong> 年度・期間・科目名</li>
            <li><strong>出席情報:</strong> 出席状態・出席済みフラグ</li>
            <li><strong>点数情報:</strong> 大問1～10の個別点数・合計点数・正答率</li>
        </ul>
        
        <p><strong>データ形式:</strong></p>
        <ul>
            <li>1行に1つのテスト結果が記録されます</li>
            <li>1人の生徒が複数のテストを受講している場合、複数行に分かれて出力されます</li>
            <li>大問がない場合は「-」で表示されます</li>
        </ul>
        
        <p><strong>注意事項:</strong></p>
        <ul>
            <li>データはExcel形式でダウンロードされます</li>
            <li>点数データが存在する生徒・テストのみが対象となります</li>
            <li>ファイル名には選択した年度・期間・生成日時が含まれます</li>
            <li>大量のデータの場合、処理に時間がかかる場合があります</li>
        </ul>
    </div>
</div>

<style>
.form-row select {
    min-width: 200px;
    padding: 5px;
    margin-left: 10px;
}

.help {
    background: #f8f8f8;
    border: 1px solid #ddd;
    padding: 15px;
    margin-top: 20px;
}

.help ul {
    margin: 5px 0 10px 20px;
}

.help li {
    margin: 3px 0;
}

.help strong {
    color: #333;
}
</style>
{% endblock %}