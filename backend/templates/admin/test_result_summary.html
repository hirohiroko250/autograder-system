{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
<style>
.custom-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    color: #333 !important;
    background-color: white !important;
}

.custom-select option {
    color: #333 !important;
    background-color: white !important;
    padding: 5px;
}

.custom-select option:checked {
    font-weight: bold;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.button-container {
    text-align: center;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    margin: 0 10px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #007cba;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label='scores' %}">å¾—ç‚¹</a>  
&rsaquo; <a href="{% url 'admin:scores_testresult_changelist' %}">ãƒ†ã‚¹ãƒˆçµæœ</a>
&rsaquo; é›†è¨ˆ
</div>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <h1>ãƒ†ã‚¹ãƒˆçµæœé›†è¨ˆ</h1>
    
    <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 20px; margin-bottom: 20px;">
        <h2>é›†è¨ˆæ¡ä»¶é¸æŠ</h2>
        <p>å¹´åº¦ãƒ»æ™‚æœŸãƒ»å­¦æ ¡ç¨®åˆ¥ã‚’é¸æŠã—ã¦é›†è¨ˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
        
        <form method="post">
            {% csrf_token %}
            <div class="form-grid">
                    
                <!-- å¹´åº¦é¸æŠ -->
                <div>
                    <label class="form-label">å¹´åº¦:</label>
                    <select name="year" required class="custom-select">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        {% for year in years %}
                            {% if selected_year|stringformat:"s" == year|stringformat:"s" %}
                            <option value="{{ year }}" selected>{{ year }}å¹´åº¦ [é¸æŠä¸­]</option>
                            {% else %}
                            <option value="{{ year }}">{{ year }}å¹´åº¦</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                    
                <!-- æ™‚æœŸé¸æŠ -->
                <div>
                    <label class="form-label">æ™‚æœŸ:</label>
                    <select name="period" required class="custom-select">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        {% for period_value, period_display in periods %}
                            {% if selected_period == period_value %}
                            <option value="{{ period_value }}" selected>{{ period_display }} [é¸æŠä¸­]</option>
                            {% else %}
                            <option value="{{ period_value }}">{{ period_display }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                    
                <!-- å­¦æ ¡ç¨®åˆ¥é¸æŠ -->
                <div>
                    <label class="form-label">å­¦æ ¡ç¨®åˆ¥:</label>
                    <select name="school_type" required class="custom-select">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        {% if selected_school_type == 'elementary' %}
                        <option value="elementary" selected>å°å­¦ç”Ÿ [é¸æŠä¸­]</option>
                        {% else %}
                        <option value="elementary">å°å­¦ç”Ÿ</option>
                        {% endif %}
                        {% if selected_school_type == 'middle' %}
                        <option value="middle" selected>ä¸­å­¦ç”Ÿ [é¸æŠä¸­]</option>
                        {% else %}
                        <option value="middle">ä¸­å­¦ç”Ÿ</option>
                        {% endif %}
                    </select>
                </div>
            </div>
                
            <div class="button-container">
                <button type="submit" name="action" value="calculate" class="btn btn-primary">
                    é›†è¨ˆå®Ÿè¡Œ
                </button>
                <button type="submit" name="action" value="view" class="btn btn-secondary">
                    çµæœè¡¨ç¤º
                </button>
            </div>
        </form>
    </div>
    
    {% if no_data_message %}
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 20px; margin-bottom: 20px; text-align: center;">
        <h3 style="color: #856404; margin-bottom: 10px;">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
        <p style="color: #856404; margin: 0;">{{ no_data_message }}</p>
        <p style="color: #6c757d; margin-top: 10px; font-size: 14px;">â€» ãƒ†ã‚¹ãƒˆçµæœãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„</p>
    </div>
    {% endif %}
    
    {% if summary_data %}
    <!-- é›†è¨ˆçµæœè¡¨ç¤º -->
    <div style="background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
        
        <!-- çµæœãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div style="
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            text-align: center;
        ">
            <h2 style="margin: 0; font-size: 24px;">ğŸ“ˆ é›†è¨ˆçµæœ</h2>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">
                {{ summary_data.test_summary.year }}å¹´åº¦{{ summary_data.test_summary.period }} 
                {% if summary_data.test_summary.school_type == 'elementary' %}å°å­¦ç”Ÿ{% else %}ä¸­å­¦ç”Ÿ{% endif %}
                å…¨å­¦å¹´ãƒ»å…¨ç§‘ç›®
            </p>
        </div>
        
        <!-- å…¨ä½“çµ±è¨ˆ -->
        <div style="padding: 30px 40px; border-bottom: 1px solid #eee;">
            <h3 style="color: #28a745; margin-bottom: 20px;">ğŸ“Š å…¨ä½“çµ±è¨ˆ</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 28px; font-weight: bold; color: #6f42c1;">{{ summary_data.test_summary.total_students }}</div>
                    <div style="color: #6c757d; margin-top: 5px;">å—é¨“è€…æ•°</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 28px; font-weight: bold; color: #fd7e14;">{{ summary_data.test_summary.average_score|floatformat:1 }}</div>
                    <div style="color: #6c757d; margin-top: 5px;">å¹³å‡ç‚¹</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 28px; font-weight: bold; color: #20c997;">{{ summary_data.test_summary.average_correct_rate|floatformat:1 }}%</div>
                    <div style="color: #6c757d; margin-top: 5px;">å¹³å‡æ­£ç­”ç‡</div>
                </div>
            </div>
        </div>
        
        <!-- å­¦å¹´åˆ¥çµ±è¨ˆ -->
        <div style="padding: 30px 40px; border-bottom: 1px solid #eee;">
            <h3 style="color: #28a745; margin-bottom: 20px;">ğŸ“š å­¦å¹´åˆ¥çµ±è¨ˆ</h3>
            
            {% for grade, grade_data in summary_data.grade_statistics.items %}
            <div style="margin-bottom: 25px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                <div style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 18px; color: #495057;">{{ grade }}å¹´ç”Ÿ</strong>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 20px; font-weight: bold; color: #fd7e14;">å¹³å‡ {{ grade_data.average_score|floatformat:1 }}ç‚¹</div>
                            <div style="color: #6c757d;">{{ grade_data.student_count }}åå—é¨“</div>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px; background: #fafafa;">
                    <h5 style="margin: 0 0 15px 0; color: #495057;">ğŸ“Š å¤§å•åˆ¥å¹³å‡ç‚¹</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                        {% for question_num, avg_score in grade_data.question_averages.items %}
                        <div style="background: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #dee2e6;">
                            <div style="font-weight: bold; color: #6f42c1; margin-bottom: 5px;">å¤§å•{{ question_num }}</div>
                            <div style="font-size: 16px; font-weight: bold; color: #fd7e14;">{{ avg_score|floatformat:1 }}ç‚¹</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- å¡¾åˆ¥çµæœ -->
        <div style="padding: 30px 40px;">
            <h3 style="color: #28a745; margin-bottom: 20px;">ğŸ« å¡¾åˆ¥çµæœï¼ˆå¹³å‡ç‚¹é †ï¼‰</h3>
            
            {% for school_summary in summary_data.school_summaries %}
            <div style="margin-bottom: 30px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                <!-- å¡¾ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div>
                            <strong style="font-size: 18px; color: #495057;">{{ school_summary.school.name }}</strong>
                            <span style="color: #6c757d; margin-left: 10px;">ï¼ˆ{{ school_summary.school.school_id }}ï¼‰</span>
                            <span style="background: #fd7e14; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">{{ school_summary.rank_among_schools }}ä½</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 20px; font-weight: bold; color: #fd7e14;">å¹³å‡ {{ school_summary.average_score|floatformat:1 }}ç‚¹</div>
                            <div style="color: #6c757d;">{{ school_summary.student_count }}åå—é¨“</div>
                        </div>
                    </div>
                </div>
                
                <!-- å­¦å¹´åˆ¥çµ±è¨ˆ -->
                <div style="padding: 20px; background: #fafafa;">
                    <h5 style="margin: 0 0 15px 0; color: #495057;">ğŸ“š å­¦å¹´åˆ¥çµ±è¨ˆ</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        {% for grade, grade_data in school_summary.grade_details.items %}
                        <div style="background: white; padding: 15px; border-radius: 6px; text-align: center; border: 1px solid #dee2e6;">
                            <div style="font-weight: bold; color: #6f42c1; margin-bottom: 5px;">{{ grade }}å¹´ç”Ÿ</div>
                            <div style="font-size: 18px; font-weight: bold; color: #fd7e14;">{{ grade_data.average_score|floatformat:1 }}ç‚¹</div>
                            <div style="color: #6c757d; font-size: 14px;">{{ grade_data.count }}å</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- ç”Ÿå¾’è©³ç´°ï¼ˆå­¦å¹´åˆ¥ï¼‰ -->
                {% for grade, grade_data in school_summary.grade_details.items %}
                <div style="margin: 20px;">
                    <h5 style="color: #6f42c1; margin-bottom: 15px;">{{ grade }}å¹´ç”Ÿã®çµæœ</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f1f3f4;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6;">ç”Ÿå¾’å</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6;">ç”Ÿå¾’ID</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6;">æ•™å®¤</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #dee2e6;">å¾—ç‚¹</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #dee2e6;">æ­£ç­”ç‡</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #dee2e6;">å¡¾å†…é †ä½</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #dee2e6;">å…¨ä½“é †ä½</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in grade_data.students %}
                                <tr style="border-bottom: 1px solid #f1f3f4;">
                                    <td style="padding: 10px;">{{ student.name }}</td>
                                    <td style="padding: 10px; color: #6c757d;">{{ student.student_id }}</td>
                                    <td style="padding: 10px; color: #6c757d;">{{ student.classroom_name }}</td>
                                    <td style="padding: 10px; text-align: center; font-weight: bold; color: #fd7e14;">{{ student.total_score }}ç‚¹</td>
                                    <td style="padding: 10px; text-align: center;">{{ student.correct_rate|floatformat:1 }}%</td>
                                    <td style="padding: 10px; text-align: center;">{{ student.school_rank }}ä½</td>
                                    <td style="padding: 10px; text-align: center;">{{ student.national_rank }}ä½</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        
        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
        <div style="padding: 20px 40px; background: #f8f9fa; text-align: center;">
            <p style="color: #6c757d; margin: 0;">
                é›†è¨ˆçµæœã¯ã€Œ{{ summary_data.test_summary.calculated_at|date:'Yå¹´næœˆjæ—¥ H:i' }}ã€ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ
            </p>
        </div>
    </div>
    {% endif %}
    
    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <div class="button-container">
        <a href="{% url 'admin:scores_testresult_changelist' %}" 
           class="btn btn-secondary">
            â† ãƒ†ã‚¹ãƒˆçµæœä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>
</div>
{% endblock %}