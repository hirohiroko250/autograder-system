<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººæˆç¸¾è¡¨ - å…¨å›½å­¦åŠ›å‘ä¸Šãƒ†ã‚¹ãƒˆ</title>
    <style>
{{ css_content|safe }}
    </style>
</head>
<body>
    <div class="report-page">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <div class="logo">
                <img src="/static/reports/logo.png" alt="å…¨å›½å­¦åŠ›å‘ä¸Šãƒ†ã‚¹ãƒˆ">
            </div>
            <div class="header-right">
                <p class="issue-date">ç™ºè¡Œæ—¥ï¼š{{ issue_date }}</p>
                <div class="test-info">
                    <span class="info-label">å­¦å¹´</span>
                    <span class="info-value">{{ student_grade }}</span>
                    <span class="info-label">ç¬¬</span>
                    <span class="info-value">{{ test_iteration }}</span>
                    <span class="info-label">å›</span>
                    <span class="info-label">å¹´åº¦</span>
                    <span class="info-value">{{ test_year }}</span>
                </div>
                <h1 class="main-title">å€‹äººæˆç¸¾è¡¨</h1>
            </div>
        </header>

        <!-- çª“ã‚ãå°ç­’ç”¨ã‚¨ãƒªã‚¢ã¨ç”Ÿå¾’æƒ…å ± -->
        <div class="top-area">
            <!-- çª“ã‚ãå°ç­’ç”¨ -->
            <div class="window-area">
                <div class="window-frame">
                    <div class="window-content">
                        <!-- ç©ºç™½ã‚¨ãƒªã‚¢ -->
                    </div>
                </div>
            </div>

            <!-- ç”Ÿå¾’æƒ…å ± -->
            <div class="student-info">
                <div class="info-row">
                    <div class="info-item">
                        <span class="label">ç”Ÿå¾’æ°å</span>
                        <span class="value">{{ student_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">å­¦å¹´</span>
                        <span class="value">{{ student_grade }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">å—é¨“ID</span>
                        <span class="value">{{ student_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">ç”Ÿå¾’ID</span>
                        <span class="value">{{ student_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">å¡¾å</span>
                        <span class="value">{{ school_name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">å¡¾ID</span>
                        <span class="value">{{ school_id }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-layout">
            <!-- å·¦å´ã‚«ãƒ©ãƒ  -->
            <div class="left-column">
                <!-- å¾—ç‚¹ãƒ»åå·®å€¤ãƒ»é †ä½ -->
                <section class="score-section">
                    <h2 class="section-title"><span class="diamond">â—†</span>å¾—ç‚¹ãƒ»åå·®å€¤ãƒ»é †ä½</h2>

                    <table class="score-table">
                        <thead>
                            <tr>
                                <th class="label-col">æ•™ç§‘</th>
                                <th class="total-col">åˆè¨ˆ</th>
                                <th class="japanese-col">å›½èª</th>
                                <th class="math-col">ç®—æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">å¾—ç‚¹</td>
                                <td class="total-cell">{{ total_score }}<span class="unit">ç‚¹</span></td>
                                <td class="japanese-cell">{{ japanese_score }}<span class="unit">ç‚¹</span></td>
                                <td class="math-cell">{{ math_score }}<span class="unit">ç‚¹</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">åå·®å€¤</td>
                                <td class="total-cell">{{ total_deviation }}</td>
                                <td class="japanese-cell">{{ japanese_deviation }}</td>
                                <td class="math-cell">{{ math_deviation }}</td>
                            </tr>
                            <tr>
                                <td class="label-cell">å­¦å¹´é †ä½<br><span class="sub-label">(å­¦å¹´å—é¨“è€…æ•°)</span></td>
                                <td class="total-cell">{{ total_grade_rank }}<span class="unit">ä½</span><br><span class="sub-value">({{ total_grade_total }}äººä¸­)</span></td>
                                <td class="japanese-cell">{{ japanese_grade_rank }}<span class="unit">ä½</span><br><span class="sub-value">({{ japanese_grade_total }}äººä¸­)</span></td>
                                <td class="math-cell">{{ math_grade_rank }}<span class="unit">ä½</span><br><span class="sub-value">({{ math_grade_total }}äººä¸­)</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">å¡¾å†…é †ä½<br><span class="sub-label">(å—é¨“è€…æ•°)</span></td>
                                <td class="total-cell">{{ total_school_rank }}<span class="unit">ä½</span><br><span class="sub-value">({{ total_school_total }}äººä¸­)</span></td>
                                <td class="japanese-cell">{{ japanese_school_rank }}<span class="unit">ä½</span><br><span class="sub-value">({{ japanese_school_total }}äººä¸­)</span></td>
                                <td class="math-cell">{{ math_school_rank }}<span class="unit">ä½</span><br><span class="sub-value">({{ math_school_total }}äººä¸­)</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">æœ€é«˜ç‚¹<br><span class="sub-label">(å…¨å›½)</span></td>
                                <td>{{ total_national_highest }}<span class="unit">ç‚¹</span></td>
                                <td>{{ japanese_national_highest }}<span class="unit">ç‚¹</span></td>
                                <td>{{ math_national_highest }}<span class="unit">ç‚¹</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">æœ€é«˜ç‚¹<br><span class="sub-label">(å¡¾å†…)</span></td>
                                <td>{{ total_school_highest }}<span class="unit">ç‚¹</span></td>
                                <td>{{ japanese_school_highest }}<span class="unit">ç‚¹</span></td>
                                <td>{{ math_school_highest }}<span class="unit">ç‚¹</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">å¹³å‡ç‚¹<br><span class="sub-label">(å­¦å¹´å¹³å‡)</span></td>
                                <td>{{ total_grade_avg }}<span class="unit">ç‚¹</span></td>
                                <td>{{ japanese_grade_avg }}<span class="unit">ç‚¹</span></td>
                                <td>{{ math_grade_avg }}<span class="unit">ç‚¹</span></td>
                            </tr>
                            <tr>
                                <td class="label-cell">å¹³å‡ç‚¹<br><span class="sub-label">(å¡¾å†…)</span></td>
                                <td>{{ total_school_avg }}<span class="unit">ç‚¹</span></td>
                                <td>{{ japanese_school_avg }}<span class="unit">ç‚¹</span></td>
                                <td>{{ math_school_avg }}<span class="unit">ç‚¹</span></td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- æˆç¸¾ã®æ¨ç§» -->
                <section class="trend-section">
                    <h2 class="section-title"><span class="diamond">â—†</span>æˆç¸¾ã®æ¨ç§»</h2>
                    <p class="trend-legend">
                        <span class="legend-item"><span class="legend-bar"></span>ã‚ãªãŸã®å¾—ç‚¹</span>
                        <span class="legend-item"><span class="legend-star">â˜…</span>å…¨å›½å¹³å‡</span>
                    </p>

                    <div class="trend-graphs">
                        <!-- å…¨æ•™ç§‘ -->
                        <div class="trend-graph total-graph">
                            <div class="graph-header total-bg">å…¨æ•™ç§‘</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 140" class="line-chart" id="totalChart_{{ student_id }}">
                                    <!-- ã‚°ãƒªãƒƒãƒ‰ç·šã¨è»¸ãƒ©ãƒ™ãƒ« -->
                                    <line x1="40" y1="20" x2="40" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <line x1="40" y1="110" x2="190" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <!-- Yè»¸ãƒ©ãƒ™ãƒ« -->
                                    <text x="20" y="20" font-size="9" fill="#666">100</text>
                                    <text x="20" y="65" font-size="9" fill="#666">50</text>
                                    <text x="28" y="115" font-size="9" fill="#666">0</text>
                                    <!-- ã‚°ãƒªãƒƒãƒ‰ç·š -->
                                    <line x1="40" y1="20" x2="190" y2="20" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                    <line x1="40" y1="65" x2="190" y2="65" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                </svg>
                            </div>
                        </div>

                        <!-- ç®—æ•° -->
                        <div class="trend-graph math-graph">
                            <div class="graph-header math-bg">ç®—æ•°</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 140" class="line-chart" id="mathChart_{{ student_id }}">
                                    <line x1="40" y1="20" x2="40" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <line x1="40" y1="110" x2="190" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <text x="20" y="20" font-size="9" fill="#666">100</text>
                                    <text x="20" y="65" font-size="9" fill="#666">50</text>
                                    <text x="28" y="115" font-size="9" fill="#666">0</text>
                                    <line x1="40" y1="20" x2="190" y2="20" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                    <line x1="40" y1="65" x2="190" y2="65" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                </svg>
                            </div>
                        </div>

                        <!-- å›½èª -->
                        <div class="trend-graph japanese-graph">
                            <div class="graph-header japanese-bg">å›½èª</div>
                            <div class="graph-content">
                                <svg viewBox="0 0 200 140" class="line-chart" id="japaneseChart_{{ student_id }}">
                                    <line x1="40" y1="20" x2="40" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <line x1="40" y1="110" x2="190" y2="110" stroke="#bdc3c7" stroke-width="2"/>
                                    <text x="20" y="20" font-size="9" fill="#666">100</text>
                                    <text x="20" y="65" font-size="9" fill="#666">50</text>
                                    <text x="28" y="115" font-size="9" fill="#666">0</text>
                                    <line x1="40" y1="20" x2="190" y2="20" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                    <line x1="40" y1="65" x2="190" y2="65" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="2,2"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- å³å´ã‚«ãƒ©ãƒ  -->
            <div class="right-column">
                <!-- å‡ºé¡Œé …ç›®åˆ¥ã®æˆç¸¾ -->
                <section class="items-section">
                    <h2 class="section-title"><span class="diamond">â—†</span>å‡ºé¡Œé …ç›®åˆ¥ã®æˆç¸¾</h2>

                    <!-- ç®—æ•° -->
                    <div class="subject-block">
                        <div class="subject-header math-bg">
                            <span class="subject-name">ç®—æ•°</span>
                        </div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="q-col">å¤§å•</th>
                                    <th class="item-col">å‡ºé¡Œé …ç›®å</th>
                                    <th class="score-col">å¾—ç‚¹/é…ç‚¹</th>
                                    <th class="avg-col">å…¨å›½å¹³å‡ç‚¹</th>
                                    <th class="rate-col">æ­£ç­”ç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in math_questions %}
                                <tr>
                                    <td>{{ question.number }}</td>
                                    <td>{{ question.title }}</td>
                                    <td>{{ question.score }}/{{ question.max_score }}<span class="unit">ç‚¹</span></td>
                                    <td>{{ question.grade_avg }}<span class="unit">ç‚¹</span></td>
                                    <td class="rate-cell">
                                        <div class="rate-container">
                                            <div class="rate-bar math-bar" style="width: {{ question.correct_rate }}%;"></div>
                                            <div class="avg-star" style="left: {{ question.grade_avg_rate }}%;">â˜…</div>
                                            <span class="rate-text">{{ question.correct_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="chart-note">ã¯å‡ºé¡Œé …ç›®åˆ¥ã®æ­£ç­”ç‡ã§ã™ã€‚<span class="note-star">â˜…</span>ã¯å…¨å›½å¹³å‡æ­£ç­”ç‡ã§ã™ã€‚</p>
                    </div>

                    <!-- å›½èª -->
                    <div class="subject-block">
                        <div class="subject-header japanese-bg">
                            <span class="subject-name">å›½èª</span>
                        </div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="q-col">å¤§å•</th>
                                    <th class="item-col">å‡ºé¡Œé …ç›®å</th>
                                    <th class="score-col">å¾—ç‚¹/é…ç‚¹</th>
                                    <th class="avg-col">å…¨å›½å¹³å‡ç‚¹</th>
                                    <th class="rate-col">æ­£ç­”ç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in japanese_questions %}
                                <tr>
                                    <td>{{ question.number }}</td>
                                    <td>{{ question.title }}</td>
                                    <td>{{ question.score }}/{{ question.max_score }}<span class="unit">ç‚¹</span></td>
                                    <td>{{ question.grade_avg }}<span class="unit">ç‚¹</span></td>
                                    <td class="rate-cell">
                                        <div class="rate-container">
                                            <div class="rate-bar japanese-bar" style="width: {{ question.correct_rate }}%;"></div>
                                            <div class="avg-star" style="left: {{ question.grade_avg_rate }}%;">â˜…</div>
                                            <span class="rate-text">{{ question.correct_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <p class="chart-note">ã¯å‡ºé¡Œé …ç›®åˆ¥ã®æ­£ç­”ç‡ã§ã™ã€‚<span class="note-star">â˜…</span>ã¯å…¨å›½å¹³å‡æ­£ç­”ç‡ã§ã™ã€‚</p>
                    </div>
                </section>

                <!-- æ•™ç§‘ã”ã¨ã®ç·è©• -->
                <section class="comment-section">
                    <h2 class="section-title"><span class="diamond">â—†</span>æ•™ç§‘ã”ã¨ã®ç·è©•</h2>

                    <div class="comment-grid">
                        <div class="comment-box math-comment">
                            <div class="comment-header math-bg">ç®—æ•°</div>
                            <p class="comment-text">{{ principal_math_comment }}</p>
                        </div>

                        <div class="comment-box japanese-comment">
                            <div class="comment-header japanese-bg">å›½èª</div>
                            <p class="comment-text">{{ principal_japanese_comment }}</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
    // æˆç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•æç”»ï¼ˆæ£’ã‚°ãƒ©ãƒ•ç‰ˆï¼‰
    (function() {
        const trends = {{ trends|safe }};
        if (!trends || trends.length === 0) return;

        function drawBarChart(svgId, scores, avgScore, color, maxScore = 100) {
            const svg = document.getElementById(svgId);
            if (!svg) return;

            const ns = "http://www.w3.org/2000/svg";

            // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®è¨ˆç®—
            const minScore = 0;
            const barWidth = 25;
            const spacing = 50;

            scores.forEach((score, index) => {
                const x = 60 + (index * spacing);
                const barHeight = ((score - minScore) / (maxScore - minScore)) * 90;
                const y = 110 - barHeight;

                // æ£’ã‚°ãƒ©ãƒ•
                const rect = document.createElementNS(ns, 'rect');
                rect.setAttribute('x', x - barWidth/2);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', color);
                rect.setAttribute('opacity', '0.8');
                svg.appendChild(rect);

                // ç‚¹æ•°è¡¨ç¤º
                const scoreText = document.createElementNS(ns, 'text');
                scoreText.setAttribute('x', x);
                scoreText.setAttribute('y', y - 5);
                scoreText.setAttribute('text-anchor', 'middle');
                scoreText.setAttribute('font-size', '10');
                scoreText.setAttribute('fill', color);
                scoreText.setAttribute('font-weight', '700');
                scoreText.textContent = Math.round(score);
                svg.appendChild(scoreText);

                // å›æ•°ãƒ©ãƒ™ãƒ«
                const labelText = document.createElementNS(ns, 'text');
                labelText.setAttribute('x', x);
                labelText.setAttribute('y', '130');
                labelText.setAttribute('text-anchor', 'middle');
                labelText.setAttribute('font-size', '10');
                labelText.setAttribute('fill', '#666');
                labelText.setAttribute('font-weight', '600');
                labelText.textContent = `${index + 1}å›`;
                svg.appendChild(labelText);
            });

            // å­¦å¹´å¹³å‡ã®æ˜Ÿå°ã¨ãƒ©ã‚¤ãƒ³
            const avgY = 110 - ((avgScore - minScore) / (maxScore - minScore)) * 90;
            scores.forEach((score, index) => {
                const x = 60 + (index * spacing);

                // æ˜Ÿå°
                const star = document.createElementNS(ns, 'text');
                star.setAttribute('x', x);
                star.setAttribute('y', avgY + 4);
                star.setAttribute('text-anchor', 'middle');
                star.setAttribute('font-size', '14');
                star.setAttribute('fill', '#ffd700');
                star.setAttribute('filter', 'drop-shadow(0 0 2px rgba(0,0,0,0.3))');
                star.textContent = 'â˜…';
                svg.appendChild(star);

                // æ˜Ÿã‚’ç·šã§ç¹‹ãï¼ˆ2å›ç›®ä»¥é™ï¼‰
                if (index > 0) {
                    const prevX = 60 + ((index - 1) * spacing);
                    const line = document.createElementNS(ns, 'line');
                    line.setAttribute('x1', prevX);
                    line.setAttribute('y1', avgY);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', avgY);
                    line.setAttribute('stroke', '#ffd700');
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('stroke-dasharray', '4,3');
                    svg.insertBefore(line, svg.firstChild);
                }
            });
        }

        const totalScores = trends.map(t => t.total_score || 0);
        const japaneseScores = trends.map(t => t.japanese_score || 0);
        const mathScores = trends.map(t => t.math_score || 0);

        drawBarChart('totalChart_{{ student_id }}', totalScores, {{ total_grade_avg }}, '#3498db', 200);
        drawBarChart('mathChart_{{ student_id }}', mathScores, {{ math_grade_avg }}, '#27ae60', 100);
        drawBarChart('japaneseChart_{{ student_id }}', japaneseScores, {{ japanese_grade_avg }}, '#e67e22', 100);
    })();
    </script>

    <!-- å°åˆ·ãƒ»PDFä¿å­˜ãƒœã‚¿ãƒ³ -->
    <script>
    window.addEventListener('load', function() {
        const printButton = document.createElement('button');
        printButton.textContent = 'ğŸ–¨ï¸ å°åˆ· / PDFä¿å­˜';
        printButton.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);';
        printButton.onclick = function() { window.print(); };
        printButton.className = 'no-print';
        document.body.appendChild(printButton);
    });
    </script>
    <style>
    @media print {
        .no-print {
            display: none !important;
        }
    }
    </style>
</body>
</html>
